---
title: "Marker_Gene_Analysis_Report"
author: "Trevor Gould"
date: "`r Sys.Date()`"
output: html_document
---

```{r, echo=FALSE}
suppressWarnings({
# loading libraries
library(plyr)
library(tidyverse)
library(readr)
library(phyloseq)
library(vegan)
library(knitr)
})
```

Loading Functions:
Create_Tables will take the inputtable and taxa tables from dada2 output in rds format
it also requires a metadata table. This table has the format: 
rows:[sample names] x columns:[variables to compare]

There is an alternative create_table function for 18S because the taxonomic columns are different
"Create_Tables_18S" that functions the same as [Create_Tables] otherwise.

```{r functions, echo=FALSE}
# 16S and ITS table creation
Create_Tables <- function(inputtable,metadata,taxa){
#row.names(inputtable) <- gsub("-trimmed","", row.names(inputtable))
#find common names
common <- intersect(rownames(metadata),rownames(inputtable))
# get just the overlapping samples
newmap <- metadata[common,, drop = FALSE]
newtable <- inputtable[common,, drop = FALSE]

# check if sampleID starts with a number and if so add an S to the start.
#if(is.numeric(substring(common[[1]], 1, 1))){
#rownames(newmap) <- paste0("S",common)
#rownames(newtable) <- paste0("S",common)
#}
#save to file
saveRDS(newtable, file = "Sequence_table_common.rds")
write.table(newmap, file = "Metadata_common.txt")
#Taxa table
newtable1 <- t(newtable)
#find common names
common <- intersect(rownames(taxa),rownames(newtable1))
# get just the overlapping samples
taxa2 <- taxa[common,, drop = FALSE]
newtable2 <- newtable1[common,, drop = FALSE]
both <- cbind(newtable2,taxa2)
both <- as.data.frame(both)

# replacing NA with Unknown higher level taxa
both$Phylum <- ifelse(is.na(both$Phylum), paste0("Unknown ",both$Kingdom), both$Phylum)
both$Class <- ifelse(is.na(both$Class), paste0("Unknown ",both$Phylum), both$Class)
both$Order <- ifelse(is.na(both$Order), paste0("Unknown ",both$Class), both$Order)
both$Family <- ifelse(is.na(both$Family), paste0("Unknown ",both$Order), both$Family)
both$Genus <- ifelse(is.na(both$Genus), paste0("Unknown ",both$Family), both$Genus)
#both$Species <- ifelse(is.na(both$Species), paste0("Unknown ",both$Genus), both$Species)
both <- data.frame(lapply(both, function(x) {gsub("Unknown Unknown", "Unknown", x)}))
both <- data.frame(lapply(both, function(x) {gsub("Unknown Unknown", "Unknown", x)}))
both <- data.frame(lapply(both, function(x) {gsub("Unknown Unknown", "Unknown", x)}))
row.names(both) <- row.names(newtable1)
#save to file
write.table(both, file = "combined_sequences_taxa.txt", sep = "\t", quote = FALSE)
# check that sizes of input and output are the same
# does inputtable = newtable
print("Checking if dimensions are the same")
print("inputtable Rows")
if(dim(inputtable)[1] == dim(newtable2)[1]){print("good")}
print("inputtable Columns")
if(dim(inputtable)[2] == dim(newtable2)[2]){print("good")}
# does metadata = newmap
print("metadatarows")
if(dim(metadata)[1] == dim(newmap)[1]){print("good")}
print("metadata columns")
if(dim(metadata)[2] == dim(newmap)[2]){print("good")}
# does taxa + inputtable = combined_taxa

return(list(newtable = newtable, newmap = newmap, combined_taxa = both))
}

# 18S table creation
Create_Tables_18S <- function(inputtable,metadata,taxa){
  #row.names(inputtable) <- gsub("-trimmed","", row.names(inputtable))
  #find common names
  common <- intersect(rownames(metadata),rownames(inputtable))
  # get just the overlapping samples
  newmap <- metadata[common,, drop = FALSE]
  newtable <- inputtable[common,, drop = FALSE]
  
  # check if sampleID starts with a number and if so add an S to the start.
  #if(is.numeric(substring(common[[1]], 1, 1))){
  #rownames(newmap) <- paste0("S",common)
  #rownames(newtable) <- paste0("S",common)
  #}
  #save to file
  saveRDS(newtable, file = "Sequence_table_common.rds")
  write.table(newmap, file = "Metadata_common.txt")
  #Taxa table
  newtable1 <- t(newtable)
  #find common names
  common <- intersect(rownames(taxa),rownames(newtable1))
  # get just the overlapping samples
  taxa2 <- taxa[common,, drop = FALSE]
  newtable2 <- newtable1[common,, drop = FALSE]
  both <- cbind(newtable2,taxa2)
  both <- as.data.frame(both)
  
  # replacing NA with Unknown higher level taxa
  both$Domain <- ifelse(is.na(both$Domain), paste0("Unknown ",both$Domain), both$Domain)
  both$Supergroup <- ifelse(is.na(both$Supergroup), paste0("Unknown ",both$Supergroup), both$Supergroup)
  both$Division <- ifelse(is.na(both$Division), paste0("Unknown ",both$Division), both$Division)
  both$Subdivision <- ifelse(is.na(both$Subdivision), paste0("Unknown ",both$Subdivision), both$Subdivision)
  both$Class <- ifelse(is.na(both$Class), paste0("Unknown ",both$Phylum), both$Class)
  both$Order <- ifelse(is.na(both$Order), paste0("Unknown ",both$Class), both$Order)
  both$Family <- ifelse(is.na(both$Family), paste0("Unknown ",both$Order), both$Family)
  both$Genus <- ifelse(is.na(both$Genus), paste0("Unknown ",both$Family), both$Genus)
  both$Species <- ifelse(is.na(both$Species), paste0("Unknown ",both$Genus), both$Species)
  both <- data.frame(lapply(both, function(x) {gsub("Unknown Unknown", "Unknown", x)}))
  both <- data.frame(lapply(both, function(x) {gsub("Unknown Unknown", "Unknown", x)}))
  both <- data.frame(lapply(both, function(x) {gsub("Unknown Unknown", "Unknown", x)}))
  row.names(both) <- row.names(newtable1)
  #save to file
  write.table(both, file = "combined_sequences_taxa.txt", sep = "\t", quote = FALSE)
  # check that sizes of input and output are the same
  # does inputtable = newtable
  print("Checking if dimensions are the same")
  print("inputtable Rows")
  if(dim(inputtable)[1] == dim(newtable2)[1]){print("good")}
  print("inputtable Columns")
  if(dim(inputtable)[2] == dim(newtable2)[2]){print("good")}
  # does metadata = newmap
  print("metadatarows")
  if(dim(metadata)[1] == dim(newmap)[1]){print("good")}
  print("metadata columns")
  if(dim(metadata)[2] == dim(newmap)[2]){print("good")}
  # does taxa + inputtable = combined_taxa
  
  return(list(newtable = newtable, newmap = newmap, combined_taxa = both))
}

# create separate taxa tables for each taxonomic level
Make_Taxa_Tables <- function(combined_taxa){
# only way that numcolwise doesn't fail for some reason.
combined_taxa <- read.table("combined_sequences_taxa.txt", sep = "\t", check.names = FALSE)
#make split taxa tables
levels <- c("Kingdom","Phylum","Class","Order","Family","Genus")
n <- (ncol(combined_taxa) - 6)
suppressWarnings({
#Domain_table <- combined_taxa %>% dplyr::select(Kingdom,1:n)
Phylum_table <- combined_taxa %>% dplyr::select(Phylum,1:n)
Class_table <- combined_taxa %>% dplyr::select(Class,1:n)
Order_table <- combined_taxa %>% dplyr::select(Order,1:n)
Family_table <- combined_taxa %>% dplyr::select(Family,1:n)
Genus_table <- combined_taxa %>% dplyr::select(Genus,1:n)
})
#KT <- plyr::ddply(Domain_table, "combined_taxa$Kingdom", plyr::numcolwise(sum))
PT <- plyr::ddply(Phylum_table, "combined_taxa$Phylum", plyr::numcolwise(sum))
CT <- plyr::ddply(Class_table, "combined_taxa$Class", plyr::numcolwise(sum))
OT <- plyr::ddply(Order_table, "combined_taxa$Order", plyr::numcolwise(sum))
FT <- plyr::ddply(Family_table, "combined_taxa$Family", plyr::numcolwise(sum))
GT <- plyr::ddply(Genus_table, "combined_taxa$Genus", plyr::numcolwise(sum))
#KT = setNames(data.frame(t(KT[,-1])), KT[,1])
PT = setNames(data.frame(t(PT[,-1])), PT[,1])
CT = setNames(data.frame(t(CT[,-1])), CT[,1])
OT = setNames(data.frame(t(OT[,-1])), OT[,1])
FT = setNames(data.frame(t(FT[,-1])), FT[,1])
GT = setNames(data.frame(t(GT[,-1])), GT[,1])
# remove columns of sum = 0
#if (any(colSums(KT,PT,CT,OT,FT,GT) == 0)){
#KT <- KT[,colSums(KT)>0]
#PT <- PT[,colSums(PT)>0]
#CT <- CT[,colSums(CT)>0]
#OT <- OT[,colSums(OT)>0]
#FT <- FT[,colSums(FT)>0]
#GT <- GT[,colSums(GT)>0]
#}
# remove "Unknown NA" column
#if (colnames(KT,PT,CT,OT,FT,GT) contains("Unknown NA")){
#KT <- KT[ , -which(names(KT) %in% c("Unknown NA"))]
#PT <- PT[ , -which(names(PT) %in% c("Unknown NA"))]
#CT <- CT[ , -which(names(CT) %in% c("Unknown NA"))]
#OT <- OT[ , -which(names(OT) %in% c("Unknown NA"))]
#FT <- FT[ , -which(names(FT) %in% c("Unknown NA"))]
#GT <- GT[ , -which(names(GT) %in% c("Unknown NA"))]
#}
#KT <- KT %>% rownames_to_column("SampleID")
PT <- PT %>% rownames_to_column("SampleID")
CT <- CT %>% rownames_to_column("SampleID")
OT <- OT %>% rownames_to_column("SampleID")
FT <- FT %>% rownames_to_column("SampleID")
GT <- GT %>% rownames_to_column("SampleID")
#write_tsv(KT, file = "Kingdom_taxonomy.txt")
write_tsv(PT, file = "Phylum_taxonomy.txt")
write_tsv(CT, file = "Class_taxonomy.txt")
write_tsv(OT, file = "Order_taxonomy.txt")
write_tsv(FT, file = "Family_taxonomy.txt")
write_tsv(GT, file = "Genus_taxonomy.txt")
return(list(PT=PT,CT=CT,OT=OT,FT=FT,GT=GT))
}

# create separate taxa tables for each taxonomic level
Make_Taxa_Tables_Species <- function(combined_taxa){
#combined_taxa <- read.table("combined_sequences_taxa.txt", sep = "\t", check.names = FALSE)
#combined_taxa <- read.table(as.character(x), sep = "\t", check.names = FALSE)
#make split taxa tables
levels <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
n <- (ncol(combined_taxa) - 7)
#`%>%` <- dplyr::`%>%`
Domain_table <- combined_taxa %>% dplyr::select(all_of(Kingdom,1:n))
Phylum_table <- combined_taxa %>% dplyr::select(all_of(Phylum,1:n))
Class_table <- combined_taxa %>% dplyr::select(all_of(Class,1:n))
Order_table <- combined_taxa %>% dplyr::select(all_of(Order,1:n))
Family_table <- combined_taxa %>% dplyr::select(all_of(Family,1:n))
Genus_table <- combined_taxa %>% dplyr::select(all_of(Genus,1:n))
Species_table <- combined_taxa %>% dplyr::select(all_of(Species,1:n))
KT <- plyr::ddply(Domain_table, "combined_taxa$Kingdom", plyr::numcolwise(sum))
PT <- plyr::ddply(Phylum_table, "combined_taxa$Phylum", plyr::numcolwise(sum))
CT <- plyr::ddply(Class_table, "combined_taxa$Class", plyr::numcolwise(sum))
OT <- plyr::ddply(Order_table, "combined_taxa$Order", plyr::numcolwise(sum))
FT <- plyr::ddply(Family_table, "combined_taxa$Family", plyr::numcolwise(sum))
GT <- plyr::ddply(Genus_table, "combined_taxa$Genus", plyr::numcolwise(sum))
ST <- plyr::ddply(Species_table, "combined_taxa$Species", plyr::numcolwise(sum))
KT = setNames(data.frame(t(KT[,-1])), KT[,1])
PT = setNames(data.frame(t(PT[,-1])), PT[,1])
CT = setNames(data.frame(t(CT[,-1])), CT[,1])
OT = setNames(data.frame(t(OT[,-1])), OT[,1])
FT = setNames(data.frame(t(FT[,-1])), FT[,1])
GT = setNames(data.frame(t(GT[,-1])), GT[,1])
ST = setNames(data.frame(t(ST[,-1])), ST[,1])
# remove columns of sum = 0
#KT <- KT[,colSums(KT)>0]
#PT <- PT[,colSums(PT)>0]
#CT <- CT[,colSums(CT)>0]
#OT <- OT[,colSums(OT)>0]
#FT <- FT[,colSums(FT)>0]
#GT <- GT[,colSums(GT)>0]
#ST <- ST[,colSums(ST)>0]
# remove "Unknown NA" column
KT <- KT[ , -which(names(KT) %in% c("Unknown NA"))]
PT <- PT[ , -which(names(PT) %in% c("Unknown NA"))]
CT <- CT[ , -which(names(CT) %in% c("Unknown NA"))]
OT <- OT[ , -which(names(OT) %in% c("Unknown NA"))]
FT <- FT[ , -which(names(FT) %in% c("Unknown NA"))]
GT <- GT[ , -which(names(GT) %in% c("Unknown NA"))]
ST <- ST[ , -which(names(ST) %in% c("Unknown NA"))]
KT <- KT %>% rownames_to_column("SampleID")
PT <- PT %>% rownames_to_column("SampleID")
CT <- CT %>% rownames_to_column("SampleID")
OT <- OT %>% rownames_to_column("SampleID")
FT <- FT %>% rownames_to_column("SampleID")
GT <- GT %>% rownames_to_column("SampleID")
ST <- ST %>% rownames_to_column("SampleID")
write_tsv(KT, file = "Kingdom_taxonomy.txt")
write_tsv(PT, file = "Phylum_taxonomy.txt")
write_tsv(CT, file = "Class_taxonomy.txt")
write_tsv(OT, file = "Order_taxonomy.txt")
write_tsv(FT, file = "Family_taxonomy.txt")
write_tsv(GT, file = "Genus_taxonomy.txt")
write_tsv(ST, file = "Species_taxonomy.txt")
return(list(PT=PT,CT=CT,OT=OT,FT=FT,GT=GT,ST=ST))
}


# diversity processing function
Diversity_Processing <- function(newmap,newtable){
#newmap <- read.table("Metadata_common.txt")
#newtable <- read.table("Sequence_table_common.rds")

# get counts
newmap$count <- rowSums(newtable)
#newmap <- newmap[-which(newmap$Eligibility_group == ""), ]

# 0 out NA cells
newtable[is.na(newtable)] <- 0
newtable2 <- t(newtable)
## clr + imputation function
## Borrowed from Gabe
## Note, this assumes taxa as rows and samples as columns
clr_transform <- function(x){
  clr.taxa <- x
  clr.taxa = t(clr.taxa); eps = 0.5
  clr.taxa = clr.taxa*(1 -rowSums(clr.taxa==0)*eps/rowSums(clr.taxa))
  clr.taxa[clr.taxa==0]=eps
  clr.taxa = sweep(clr.taxa,1,rowSums(clr.taxa),'/');
  ls = log(clr.taxa)
  clr.taxa = t(ls - rowMeans(ls))
  clr.taxa = clr.taxa[,!is.nan(colSums(clr.taxa))]
  return(clr.taxa)
}

data.CLR <- clr_transform(newtable2)
data.CLR <- t(data.CLR)

# get just the overlapping samples
#meta <- newmap[-which(newmap$Eligibility_group == ""), ]
common <- intersect(rownames(data.CLR),rownames(newmap))
data.CLR <- data.CLR[common,, drop = FALSE]
newmap <- newmap[common,, drop = FALSE]
newtable <- newtable[common,, drop = FALSE]

#PCA
d.mes <- prcomp(data.CLR, scale = FALSE)
var_explained = (d.mes$sdev^2/sum(d.mes$sdev^2))*100
var_explained = format(round(var_explained, 2), nsmall = 2)

#eigenvalues
newmap$EV <- d.mes$sdev^2
brayWmeta <- cbind(newmap,d.mes$x[,1:4])
newtable2 <- t(newtable)
brayWmeta$chao1 <- apply(newtable2, 2, OTUtable::chao1)
#alpha_diversity_stats
propdist <- sweep(newtable, 1, rowSums(newtable),'/')
brayWmeta$shannon <- vegan::diversity(propdist, index = "shannon")
brayWmeta$simpson <- vegan::diversity(propdist, index = "simpson")
#brayWmeta$invsimpson <- vegan::diversity(propdist, index = "invsimpson")


############
# RAREFEACTION
# first we need to see what the sample counts look like to pick a sample number
# get counts
# This assumes samples = ROWS
min(rowSums(newtable))
hist(rowSums(newtable))
sampler = min(rowSums(newtable))
scount <- as.data.frame(rowSums(newtable))
print(paste("lowest sample size is: ", sampler))
if (sampler < 1000){
  print("Setting rarefaction threshold to: 1000")
  # set minimum sequences per sample
  keepers <- rowSums(newtable)>1000
  newtable <- newtable[keepers,]
  sampler = 1000
  scount$col <- cut(scount$scount, breaks = c(-Inf,1000,Inf), labels = c("<1000",">1000"))
  ggplot(scount, aes(x = scount)) + geom_dotplot(binwidth = 1000, aes(fill = col)) + geom_vline(xintercept = 1000, color = "red") + ylab("Samples") + xlab("Sequences") + scale_fill_manual(values = c("red","black"))
} else {
  print(paste("Setting rarefaction threshold to: ", sampler))
}

# then we rarefy the datatable at chosen sample size
rarefyAt <- function(newtable,sampler){
  # we want to do rrarefy 1000 times and get the average   
  # lets try with 10 first
  res <- lapply(as.list(1:1000), function(x) rrarefy(newtable, sample=sampler))
  FULL <- aaply(laply(res, as.matrix), c(2, 3), mean)
  rm(res)
  return(FULL)
}
out <- rarefyAt(newtable,sampler)
# now we're going to compare the 1000 times rarefied table to the original run via clr transform
propdistout <- sweep(out, 1, rowSums(out),'/')
# distance:
d2.mes <- vegdist(propdistout, method = "bray")
PCOA <- cmdscale(d2.mes, k = 3, eig = TRUE)
# from diversity.R get brayWmeta
brayWmeta$PC3pcoa <- PCOA$points[,3]
brayWmeta$PC2pcoa <- PCOA$points[,2]
brayWmeta$PC1pcoa <- PCOA$points[,1]
###################
round(PCOA$eig*100/sum(PCOA$eig),2)
write.table(brayWmeta, file="proportional_diversity_stats.txt", quote = FALSE)
outlist <- list("brayWmeta"=brayWmeta,"PCOA" = PCOA)
return(outlist)
}

# niche stat functions
adonis_stats <- function(newmap,newtable,var1,var2){
  set.seed(12345)
  # get counts
  newmap$Scount <- rowSums(newtable)
  
  # 0 out NA cells
  newtable[is.na(newtable)] <- 0
  newtable2 <- t(newtable)
  
  ## clr + imputation function
  ## Borrowed from Gabe
  ## Note, this assumes taxa as rows and samples as columns
  clr_transform <- function(x){
    clr.taxa <- x
    clr.taxa = t(clr.taxa); eps = 0.5
    clr.taxa = clr.taxa*(1 -rowSums(clr.taxa==0)*eps/rowSums(clr.taxa))
    clr.taxa[clr.taxa==0]=eps
    clr.taxa = sweep(clr.taxa,1,rowSums(clr.taxa),'/');
    ls = log(clr.taxa)
    clr.taxa = t(ls - rowMeans(ls))
    clr.taxa = clr.taxa[,!is.nan(colSums(clr.taxa))]
    return(clr.taxa)
  }
  data.CLR <- clr_transform(newtable2)
  data.CLR <- t(data.CLR)
  
  # get just the overlapping samples
  common <- intersect(rownames(data.CLR),rownames(newmap))
  data.CLR <- data.CLR[common,, drop = FALSE]
  newmap <- newmap[common,, drop = FALSE]
  newtable <- newtable[common,, drop = FALSE]
  
  # dist
  out <- dist(data.CLR)
  
  # adonis
  aout <- adonis2(out ~ var1 + Scount, data = newmap, permutations = 10000)
  return(aout)
}

# plotting functions
Adiv <- function(x,brayWmeta) {
  suppressWarnings({
    Group = brayWmeta %>% select(x)
  })
    ShanD <- ggplot2::ggplot(brayWmeta, ggplot2::aes(Group[,1], shannon, colour = Group[,1])) + ggplot2::geom_boxplot(outlier.shape = NA) + ggplot2::geom_point(position=ggplot2::position_jitterdodge(),alpha=0.3)+ ggplot2::theme_bw() + ggplot2::theme(legend.position = "NA") + ggplot2::ylab("Shannon") +  ggplot2::theme(axis.title.x=ggplot2::element_blank(), axis.text.x=ggplot2::element_blank(),axis.ticks.x=ggplot2::element_blank())
    SimD <- ggplot2::ggplot(brayWmeta, ggplot2::aes(Group[,1], simpson, colour = Group[,1])) + ggplot2::geom_boxplot(outlier.shape = NA) + ggplot2::geom_point(position=ggplot2::position_jitterdodge(),alpha=0.3)+ ggplot2::theme_bw() + ggplot2::theme(legend.position = "NA") + ggplot2::ylab("Simpson") + ggplot2::theme(axis.title.x=ggplot2::element_blank(), axis.text.x=ggplot2::element_blank(),axis.ticks.x=ggplot2::element_blank())
    SimI <- ggplot2::ggplot(brayWmeta, ggplot2::aes(Group[,1], chao1, colour = Group[,1])) + ggplot2::geom_boxplot(outlier.shape = NA) + ggplot2::geom_point(position=ggplot2::position_jitterdodge(),alpha=0.3)+ ggplot2::theme_bw() + ggplot2::theme(legend.position = "bottom") + ggplot2::ylab("Chao1") + ggplot2::xlab(x) + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1)) + scale_color_discrete(name = x)
    #combinded_plot <- ShanD / SimD / SimI
    combinded_plot <- gridExtra::grid.arrange(ShanD,SimD,SimI, ncol = 1)
    plottitle <- paste0("AlphaDiversity_plots_",x,".png")
    ggplot2::ggsave(combinded_plot, file=plottitle, dpi=800, height = 12, width = 6, units = "in")
}

# ggplot functions for PCAs
bdiv <- function(j,brayWmeta) {
var_explained = (brayWmeta$EV/sum(brayWmeta$EV))*100
var_explained = format(round(var_explained, 2), nsmall = 2)
suppressWarnings({
  Group = brayWmeta %>% select(j)
})
    PC1PC2 <- ggplot2::ggplot(brayWmeta, ggplot2::aes(PC1,PC2, colour = Group[,1])) + ggplot2::geom_point(size=2) + ggplot2::theme_bw() + ggplot2::theme(legend.position = "NA")  + ggplot2::xlab(paste0("PC1: ",(var_explained[1]), "% variance")) + ggplot2::ylab(paste0("PC2: ",(var_explained[2]), "% variance")) + scale_color_discrete(name = j)
    PC1PC3 <- ggplot2::ggplot(brayWmeta, ggplot2::aes(PC1,PC3, colour = Group[,1])) + ggplot2::geom_point(size=2) + ggplot2::theme_bw() + ggplot2::theme(legend.position = "bottom")  + ggplot2::xlab(paste0("PC1: ",(var_explained[1]), "% variance")) + ggplot2::ylab(paste0("PC3: ",(var_explained[3]), "% variance")) + scale_color_discrete(name = j)
    #combinded_plot2 <- PC1PC2 / PC1PC3
    combinded_plot2 <- gridExtra::grid.arrange(PC1PC2, PC1PC3, ncol = 1)
    plottitle <- paste0("PCA_PC12_PC13_continuous",j,".png")
    ggplot2::ggsave(combinded_plot2, file=plottitle, dpi=800, height = 8, width = 6, units = "in")
}

# ggplot functions for PCoAs
bdivrare <- function(j,brayWmeta) {
  Group = brayWmeta %>% select(j)
var_explained_PCoA = (PCOA$eig/sum(PCOA$eig))*100
var_explained_PCoA = format(round(var_explained_PCoA, 2), nsmall = 2)

  PC1PC2 <- ggplot2::ggplot(brayWmeta, ggplot2::aes(PC1pcoa,PC2pcoa, colour = Group[,1])) + ggplot2::geom_point(size=2) + ggplot2::theme_bw() + ggplot2::theme(legend.position = "NA")  + ggplot2::xlab(paste0("PC1: ",var_explained_PCoA[1], "% variance")) + ggplot2::ylab(paste0("PC2: ",var_explained_PCoA[2], "% variance")) + scale_color_discrete(name = j)
  PC1PC3 <- ggplot2::ggplot(brayWmeta, ggplot2::aes(PC1pcoa,PC3pcoa, colour = Group[,1])) + ggplot2::geom_point(size=2) + ggplot2::theme_bw() + ggplot2::theme(legend.position = "bottom")  + ggplot2::xlab(paste0("PC1: ",var_explained_PCoA[1], "% variance")) + ggplot2::ylab(paste0("PC3: ",var_explained_PCoA[3], "% variance")) + scale_color_discrete(name = j)
  #combinded_plot2 <- PC1PC2 / PC1PC3
  combinded_plot2 <- gridExtra::grid.arrange(PC1PC2, PC1PC3, ncol = 1)
  plottitle <- paste0("Rareified_PCoA_PC12_PC13_continuous_",j,".png")
  ggplot2::ggsave(combinded_plot2, file=plottitle, dpi=800, height = 8, width = 6, units = "in")
}

Adiv2 <- function(x,brayWmeta) {
  Group = brayWmeta %>% select(x)
  subbed <- brayWmeta[!brayWmeta[,x] == "",]
  brayWmeta <- subbed %>% drop_na(x)
  my_comparisons <- unique(brayWmeta[,x])
  out <- crossing(my_comparisons,my_comparisons)
  out2 <- subset(out, out[,1] != out[,2])
  makecomp <- out2[as.character(out2$my_comparisons...1) < as.character(out2$my_comparisons...2),]
  comparisons = list(makecomp[1,], makecomp[2,],makecomp[3,],makecomp[4,])
  ShanD <- ggplot2::ggplot(brayWmeta, ggplot2::aes(Group, brayWmeta$shannon, colour = Group)) + ggplot2::geom_boxplot(outlier.shape = NA) + ggplot2::geom_point(position=ggplot2::position_jitterdodge(),alpha=0.3)+ ggplot2::theme_bw() + ggplot2::theme(legend.position = "NA") + ggplot2::ylab("Shannon") + ggplot2::theme(axis.title.x=ggplot2::element_blank(), axis.text.x=ggplot2::element_blank(),axis.ticks.x=ggplot2::element_blank()) + stat_compare_means(comparisons = comparisons) + stat_compare_means()
  SimD <- ggplot2::ggplot(brayWmeta, ggplot2::aes(Group, brayWmeta$simpson, colour = Group)) + ggplot2::geom_boxplot(outlier.shape = NA) + ggplot2::geom_point(position=ggplot2::position_jitterdodge(),alpha=0.3)+ ggplot2::theme_bw() + ggplot2::theme(legend.position = "NA") + ggplot2::ylab("Simpson") + ggplot2::theme(axis.title.x=ggplot2::element_blank(), axis.text.x=ggplot2::element_blank(),axis.ticks.x=ggplot2::element_blank()) + stat_compare_means(comparisons =comparisons) + stat_compare_means()
  SimI <- ggplot2::ggplot(brayWmeta, ggplot2::aes(Group, brayWmeta$chao1, colour = Group)) + ggplot2::geom_boxplot(outlier.shape = NA) + ggplot2::geom_point(position=ggplot2::position_jitterdodge(),alpha=0.3)+ ggplot2::theme_bw() + ggplot2::theme(legend.position = "bottom") + ggplot2::ylab("Chao1") + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1)) + stat_compare_means(comparisons = comparisons) + stat_compare_means()
  #combinded_plot <- ShanD / SimD / SimI
  combinded_plot <- gridExtra::grid.arrange(ShanD,SimD,SimI, ncol = 1)
  plottitle <- paste0("AlphaDiversity_plots_",x,"_significance.png")
  ggplot2::ggsave(combinded_plot, file=plottitle, dpi=800, height = 12, width = 6, units = "in")
}

# Diversity plots
Diversity_Plots <- function(h){
meta <- outtab$newmap
t=10
brayWmeta <- read.table('proportional_diversity_stats.txt')
# newmap <- read.table("Metadata_common.txt")

Adiv(h,brayWmeta)
bdiv(h,brayWmeta)
bdivrare(h,brayWmeta)
}

# taxonomy plots
Taxonomy_Plots <- function(h){
# read in tables
pal = c('#91bfdb','#ffffbf','#fc8d59')
meta <- outtab$newmap
#KT <- read.table(file = "Kingdom_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
PT <- read.table(file = "Phylum_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
CT <- read.table(file = "Class_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
OT <- read.table(file = "Order_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
FT <- read.table(file = "Family_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
GT <- read.table(file = "Genus_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
#ST <- read.table(file = "Species_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)

suppressWarnings({
Group = meta %>% select(h)
#Gname <- colnames(Group)
})
# Here we are taking the taxonomy tables created above
# taxa with less than a sum of 0.1 total proportion over all samples are merged
# into a column of OTHER with the NA column if it is present.
# NEXT IS TO DYNAMICALLY SET THE 0.1 TO LEAVE 20 TAXA TOTAL WITH OTHER AS REST.
taxa_list <- list(PT,CT,OT,FT,GT)
taxa_names <- list("Phylum","Class","Order","Family","Genus")
for (x in 1:5){
XT_other = 0
xt=0
XTtax=0
name_label <- taxa_names[x]
xt=as.data.frame(taxa_list[x])
xt=xt[(rowSums(xt)>0),]

# fix rownames . to -
row.names(meta) <- gsub("-", "\\.", row.names(Group))

#find common names
common <- intersect(rownames(Group),rownames(xt))
# get just the overlapping samples
Group <- Group[common,, drop = FALSE]
xt <- xt[common,, drop = FALSE]


XTtax = sweep(xt, 1, rowSums(xt),'/')
# KEEP TOP TAXA AND SORT REST INTO OTHER CATEGORY AND PLOT
# get taxa that are present > 0.1
XT_other <- XTtax[,(colSums(XTtax)>=0.1)]
# sum taxa less then 0.1

if (table(colSums(XTtax)<0.1)["TRUE"] > 1){
XT_other$other <- rowSums(XTtax[,(colSums(XTtax)<0.1)])

#
if("NA." %in% colnames(XT_other))
{
cat("Merging NA column with Other!\n");
XT_other$Other <- XT_other$'NA.' + XT_other$other
# remove columns NA and other
XT_other <- XT_other[ , -which(names(XT_other) %in% c("NA.","other"))]
}
b <- sum(nrow(XT_other))
a <- as.integer(sum(rowSums(XT_other)))

if(a!=b){
 cat("taxa do not sum to 100. there is something wrong\n")
}
}


both <- cbind(XT_other,Group)
both$Samples <- row.names(Group)
melted <- reshape2::melt(both, id.vars = c(colnames(Group),"Samples"))
melted$variable <- gsub("[a-z]__", "", melted$variable)
melted$variable <- gsub("\\.", " ", melted$variable)
filename <- paste0(name_label,"_taxonomy_",colnames(Group),".png")
filename2 <- paste0(name_label,"_taxonomy_table_",colnames(Group),".txt")
p <- ggplot2::ggplot(melted, ggplot2::aes(Samples, (value*100), fill = variable)) + ggplot2::geom_bar(stat='identity')+ ggplot2::ylab("Percent") + facet_grid(~melted[,1], scales = "free") + ggplot2::theme_bw() + ggplot2::theme(legend.position = "bottom") + ggplot2::theme(axis.text.x=element_blank(),axis.ticks=element_blank()) + ggplot2::scale_fill_discrete(name = name_label)
ggplot2::ggsave(p, file = filename, dpi  = 800, width = 14, height = 8, units = "in")
write.table(both, file = filename2, sep = "\t", quote = FALSE)

melted$variable = with(melted, reorder(variable,value,mean))
p2 <- ggplot(melted, aes(Samples,variable, fill=value)) + geom_tile(color="white", linewidth=0.1) + facet_grid(~melted[,1], scales = "free") + ylab(name_label) + theme(axis.text.y = element_text(size = 8),axis.text.x=element_blank(),axis.ticks=element_blank()) + scale_fill_gradientn(colours = pal,name = "Proportion")
filename3 <- paste0(name_label,"_taxonomy_heat.png")
ggplot2::ggsave(p2, file = filename3, dpi  = 800, width = 6, height = 10, units = "in")
}
}

# top 10 taxa
Taxonomy_Plots_Top10 <- function(h){
  # top t taxa
  t=10
  # read in tables
  pal = c('#91bfdb','#ffffbf','#fc8d59')
  #meta <- read.table("Metadata_common.txt", sep = "\t", check.names = FALSE)
  #KT <- read.table(file = "Kingdom_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
  PT <- read.table(file = "Phylum_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
  CT <- read.table(file = "Class_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
  OT <- read.table(file = "Order_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
  FT <- read.table(file = "Family_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
  GT <- read.table(file = "Genus_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
  #ST <- read.table(file = "Species_taxonomy.txt", sep = "\t", check.names = FALSE, header = TRUE, row.names = 1)
meta <- outtab$newmap
suppressWarnings({
Group = meta %>% select(h)
})
  # Here we are taking the taxonomy tables created above
  # taxa with less than a sum of 0.1 total proportion over all samples are merged
  # into a column of OTHER with the NA column if it is present.
  # NEXT IS TO DYNAMICALLY SET THE 0.1 TO LEAVE 20 TAXA TOTAL WITH OTHER AS REST.
  taxa_list <- list(PT,CT,OT,FT,GT)
  taxa_names <- list("Phylum","Class","Order","Family","Genus")
  for (x in 1:5){
    XT_other = 0
    xt=0
    XTtax=0
    name_label <- taxa_names[x]
    xt=as.data.frame(taxa_list[x])
    xt=xt[(rowSums(xt)>0),]

    # fix rownames . to -
    row.names(meta) <- gsub("-", "\\.", row.names(meta))

    #find common names
    common <- intersect(rownames(meta),rownames(xt))
    # get just the overlapping samples
    meta <- meta[common,, drop = FALSE]
    xt <- xt[common,, drop = FALSE]


    XTtax = sweep(xt, 1, rowSums(xt),'/')
    # KEEP TOP TAXA AND SORT REST INTO OTHER CATEGORY AND PLOT
    # get taxa that are present > 0.1
    if (ncol(XTtax) > t){
      topt <- rownames(as.data.frame(head(sort(colSums(XTtax), decreasing = TRUE), n=t)))
      nottopt <- rownames(as.data.frame(sort(colSums(XTtax), decreasing = TRUE)))
      nottopt <- nottopt[-c(1:t)]
      XT_other <- XTtax[,topt]
      XT_other$other <- rowSums(XTtax[,nottopt])

      #
      if("NA." %in% colnames(XT_other))
      {
        cat("Merging NA column with Other!\n");
        XT_other$Other <- XT_other$'NA.' + XT_other$other
        # remove columns NA and other
        XT_other <- XT_other[ , -which(names(XT_other) %in% c("NA.","other"))]
      }
      b <- sum(nrow(XT_other))
      a <- as.integer(sum(rowSums(XT_other)))
      
      if(a!=b){
        cat("taxa do not sum to 100. there is something wrong\n")
      }
    }


    both <- cbind(XT_other,Group)
    both$Samples <- row.names(Group)
    melted <- reshape2::melt(both, id.vars = c(colnames(Group),"Samples"))
    melted$variable <- gsub("[a-z]__", "", melted$variable)
    melted$variable <- gsub("\\.", " ", melted$variable)
    filename <- paste0(name_label,"_taxonomy_top",t,"_Type_boxplot.png")
    filename2 <- paste0(name_label,"_taxonomy_top",t,".txt")
    titlename <- paste0("Top_",t,"_",name_label)
    forcolors <- c(rep(c("#899DA4", "#C93312"), times = 6))
    color4 = c("#BB3717","#54969A","#B47F6D","#0F5372")
    color3 = c("#A9502D","#678076","#C7723A")
p <- ggplot2::ggplot(melted, ggplot2::aes(melted[,1], value, fill = melted[,1])) + ggplot2::geom_boxplot()+ ggplot2::ylab("Proportion") + ggplot2::scale_fill_manual(values = color4, name = t) + facet_grid(~reorder(variable, -value, mean), scales = "free", switch="both")+ theme_bw()+theme(strip.text.y.left = element_text(angle = 0),axis.text.x=element_blank(),axis.ticks=element_blank(),strip.text=element_text(margin=margin()),panel.spacing=unit(0, "lines"),legend.position="bottom") + ggtitle(titlename) + xlab(name_label)
    ggplot2::ggsave(p, file = filename, dpi  = 800, width = 14, height = 8, units = "in")
    write.table(both, file = filename2, sep = "\t", quote = FALSE)
       }
}

```

First we need to read in the files

Here we assume this script is being run in the directory that contains the files:
[seqtab_nochim.rds]
[taxa.rds]
[metadata.txt]

Do These files look correct:
```{r}
# load files from dada2 output
inputtable <- readRDS("seqtab_nochim.rds")
taxa <- readRDS("taxa.rds")
metadata <- read.delim("metadata.txt", row.names=1, header=TRUE)
```

Next we create the tables used for all analysis:

```{r}
outtab <- Create_Tables(inputtable,metadata,taxa)
combined_taxa = outtab$combined_taxa
outtax <- Make_Taxa_Tables(combined_taxa)
```

Running initial statistical diversity analysis
```{r}

newmap = outtab$newmap
newtable = outtab$newtable
divout <- Diversity_Processing(newmap,newtable)
brayWmeta = divout$brayWmeta
PCOA = divout$PCOA
```
Histogram of sequence count of samples. 
The downside of rarefaction is you have to downsample to the sample with the least sequences. 
This is signified by the rarefaction threshold. 


Creating taxonomy plots
```{r}
comp <- colnames(newmap)
lapply(comp,Taxonomy_Plots)
lapply(comp,Taxonomy_Plots_Top10)
```



Creating diversity plots
```{r}
# need to cycle through a column variable here
comp <- colnames(newmap)
lapply(comp, Diversity_Plots)
```

Report Provided my MSI - Research Informatics
